(function(root, factory) {
  var StateManager, exports, _;
  if (typeof define === 'function' && define.amd) {
    define('State', ['StateManager', 'underscore'], function(StateManager, _) {
      return root.State = factory(StateManager, _);
    });
  } else if (typeof exports !== 'undefined') {
    StateManager = require('StateManager');
    _ = require('underscore');
    exports.State = factory(StateManager, _);
    if (typeof module !== 'undefined' && module.exports) {
      return exports = module.exports = factory(StateManager, _);
    }
  } else {
    return root.State = factory(StateManager, _);
  }
})(this, function(StateManager, _) {
  'use strict';
  var State;
  _.templateSettings = {
    interpolate: /:([a-zA-Z0-9_]+)/g
  };
  return State = (function() {
    State.prototype.isActive = false;

    function State() {
      StateManager.registerState(this);
    }

    State.prototype.doResolve = function(parameters, parentResolveResults) {
      var deferred, name, resolveFunction, resultPromise, subPromiseList, _ref;
      if (parentResolveResults == null) {
        parentResolveResults = {};
      }
      resultPromise = $.Deferred();
      if (!this.resolve) {
        resultPromise.resolve(parentResolveResults);
        return resultPromise;
      } else {
        subPromiseList = [];
        _ref = this.resolve;
        for (name in _ref) {
          resolveFunction = _ref[name];
          deferred = resolveFunction.apply(this, parameters, parentResolveResults);
          deferred.name = name;
          subPromiseList.push(deferred);
        }
        ($.when.apply($, subPromiseList)).then(function() {
          var index, subPromise;
          for (index in subPromiseList) {
            subPromise = subPromiseList[index];
            parentResolveResults[subPromise.name] = arguments[index];
          }
          return resultPromise.resolve(parentResolveResults);
        });
      }
      return resultPromise;
    };

    State.prototype.activate = function(parameters, child, activationPromise) {
      var initial, resolvePromise, _ref;
      if (child == null) {
        child = null;
      }
      if (activationPromise == null) {
        activationPromise = $.Deferred();
      }
      initial = child === null;
      resolvePromise = $.Deferred();
      if (initial) {
        resolvePromise.then(function(resolveResult) {
          return activationPromise.resolve(resolveResult);
        });
      }
      if (this.currentChild !== child) {
        if ((_ref = this.currentChild) != null) {
          _ref.deactivate();
        }
        this.currentChild = child;
      }
      if (!(this.isActive && this.generateRoute(this.currentParameters) === this.generateRoute(parameters))) {
        if (this.parent) {
          this.parent.activate(parameters, this, activationPromise).then((function(_this) {
            return function(parentResolveResult) {
              return _this.doResolve(parameters, parentResolveResult).then(function(resolveResult) {
                _this.previousResolveResult = resolveResult;
                return resolvePromise.resolve(resolveResult);
              });
            };
          })(this));
        } else {
          this.doResolve(parameters).then((function(_this) {
            return function(resolveResult) {
              _this.previousResolveResult = resolveResult;
              return resolvePromise.resolve(resolveResult);
            };
          })(this));
        }
        this.currentChild = child;
        this.isActive = true;
      } else {
        resolvePromise.resolve(this.previousResolveResult);
      }
      activationPromise.then((function(_this) {
        return function(resolveResult) {
          return typeof _this.onActivate === "function" ? _this.onActivate(parameters, resolveResult) : void 0;
        };
      })(this));
      this.currentParameters = parameters;
      return resolvePromise;
    };

    State.prototype.deactivate = function() {
      var _ref;
      this.isActive = false;
      if (typeof this.onDeactivate === "function") {
        this.onDeactivate();
      }
      if ((_ref = this.currentChild) != null) {
        _ref.deactivate();
      }
      return this.currentChild = null;
    };

    State.prototype.generateRoute = function(parameters) {
      var _ref;
      return (((_ref = this.parent) != null ? _ref.generateRoute(parameters).length : void 0) ? this.parent.generateRoute(parameters) + '/' : '') + (this.route ? _.template(this.route)(parameters) : '');
    };

    State.prototype.generateRouteString = function() {
      var _ref;
      return (((_ref = this.parent) != null ? _ref.generateRouteString().length : void 0) ? this.parent.generateRouteString() + (this.route ? '/' : '') : '') + (this.route ? this.route : '');
    };

    State.prototype.generateName = function() {
      var _ref;
      return (((_ref = this.parent) != null ? _ref.statename : void 0) ? this.parent.generateName() + '.' : '') + this.statename;
    };

    State.prototype.getParentChain = function() {
      var chain, _ref;
      chain = ((_ref = this.parent) != null ? _ref.getParentChain() : void 0) || [];
      chain.push(this);
      return chain;
    };

    return State;

  })();
});

//# sourceMappingURL=data:application/json;base64,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QSxXQUFBLElBQTZCLEVBQXJDLENBQUE7QUFBQSxNQUNBLEtBQUssQ0FBQyxJQUFOLENBQVcsSUFBWCxDQURBLENBQUE7QUFFQSxhQUFPLEtBQVAsQ0FIYztJQUFBLENBcEVoQixDQUFBOztpQkFBQTs7T0FOSTtBQUFBLENBYlIsQ0FBQSxDQUFBIiwiZmlsZSI6IlN0YXRlLmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiKChyb290LCBmYWN0b3J5KS0+XG4gIGlmIHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyBhbmQgZGVmaW5lLmFtZFxuICAgIGRlZmluZSAnU3RhdGUnLCBbJ1N0YXRlTWFuYWdlcicsICd1bmRlcnNjb3JlJ10sIChTdGF0ZU1hbmFnZXIsIF8pLT5cbiAgICAgIHJvb3QuU3RhdGUgPSAoZmFjdG9yeSBTdGF0ZU1hbmFnZXIsIF8pXG4gICAgcmV0dXJuXG4gIGVsc2UgaWYgdHlwZW9mIGV4cG9ydHMgIT0gJ3VuZGVmaW5lZCdcbiAgICBTdGF0ZU1hbmFnZXIgPSByZXF1aXJlICdTdGF0ZU1hbmFnZXInXG4gICAgXyA9IHJlcXVpcmUgJ3VuZGVyc2NvcmUnXG4gICAgZXhwb3J0cy5TdGF0ZSA9IChmYWN0b3J5IFN0YXRlTWFuYWdlciwgXylcbiAgICBpZiB0eXBlb2YgbW9kdWxlICE9ICd1bmRlZmluZWQnIGFuZCBtb2R1bGUuZXhwb3J0c1xuICAgICAgZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gKGZhY3RvcnkgU3RhdGVNYW5hZ2VyLCBfKVxuICBlbHNlXG4gICAgcm9vdC5TdGF0ZSA9IChmYWN0b3J5IFN0YXRlTWFuYWdlciwgXylcbikodGhpcywgKFN0YXRlTWFuYWdlciwgXykgLT5cbiAgJ3VzZSBzdHJpY3QnXG4gIF8udGVtcGxhdGVTZXR0aW5ncyA9XG4gICAgaW50ZXJwb2xhdGU6IC86KFthLXpBLVowLTlfXSspL2dcblxuICBjbGFzcyBTdGF0ZVxuICAgIGlzQWN0aXZlOiBmYWxzZVxuXG4gICAgY29uc3RydWN0b3I6ICgpLT5cbiAgICAgIFN0YXRlTWFuYWdlci5yZWdpc3RlclN0YXRlIEBcblxuICAgIGRvUmVzb2x2ZTogKHBhcmFtZXRlcnMsIHBhcmVudFJlc29sdmVSZXN1bHRzID0ge30pLT5cbiAgICAgIHJlc3VsdFByb21pc2UgPSAkLkRlZmVycmVkKClcbiAgICAgIHVubGVzcyBAcmVzb2x2ZVxuICAgICAgICByZXN1bHRQcm9taXNlLnJlc29sdmUgcGFyZW50UmVzb2x2ZVJlc3VsdHNcbiAgICAgICAgcmV0dXJuIHJlc3VsdFByb21pc2VcbiAgICAgIGVsc2VcbiAgICAgICAgc3ViUHJvbWlzZUxpc3QgPSBbXVxuICAgICAgICBmb3IgbmFtZSwgcmVzb2x2ZUZ1bmN0aW9uIG9mIEByZXNvbHZlXG4gICAgICAgICAgZGVmZXJyZWQgPSByZXNvbHZlRnVuY3Rpb24uYXBwbHkgQCwgcGFyYW1ldGVycywgcGFyZW50UmVzb2x2ZVJlc3VsdHNcbiAgICAgICAgICBkZWZlcnJlZC5uYW1lID0gbmFtZVxuICAgICAgICAgIHN1YlByb21pc2VMaXN0LnB1c2ggZGVmZXJyZWRcbiAgICAgICAgKCQud2hlbi5hcHBseSAkLCBzdWJQcm9taXNlTGlzdCkudGhlbiAoKS0+XG4gICAgICAgICAgZm9yIGluZGV4LCBzdWJQcm9taXNlIG9mIHN1YlByb21pc2VMaXN0XG4gICAgICAgICAgICBwYXJlbnRSZXNvbHZlUmVzdWx0c1tzdWJQcm9taXNlLm5hbWVdID0gYXJndW1lbnRzW2luZGV4XVxuICAgICAgICAgIHJlc3VsdFByb21pc2UucmVzb2x2ZSBwYXJlbnRSZXNvbHZlUmVzdWx0c1xuICAgICAgcmVzdWx0UHJvbWlzZVxuXG4gICAgYWN0aXZhdGU6IChwYXJhbWV0ZXJzLCBjaGlsZCA9IG51bGwsIGFjdGl2YXRpb25Qcm9taXNlID0gJC5EZWZlcnJlZCgpKS0+XG4gICAgICBpbml0aWFsID0gY2hpbGQgPT0gbnVsbFxuICAgICAgcmVzb2x2ZVByb21pc2UgPSAkLkRlZmVycmVkKClcbiAgICAgIGlmIGluaXRpYWxcbiAgICAgICAgcmVzb2x2ZVByb21pc2UudGhlbiAocmVzb2x2ZVJlc3VsdCktPlxuICAgICAgICAgIGFjdGl2YXRpb25Qcm9taXNlLnJlc29sdmUgcmVzb2x2ZVJlc3VsdFxuICAgICAgdW5sZXNzIEBjdXJyZW50Q2hpbGQgPT0gY2hpbGRcbiAgICAgICAgQGN1cnJlbnRDaGlsZD8uZGVhY3RpdmF0ZSgpXG4gICAgICAgIEBjdXJyZW50Q2hpbGQgPSBjaGlsZFxuICAgICAgdW5sZXNzIEBpc0FjdGl2ZSBhbmQgQGdlbmVyYXRlUm91dGUoQGN1cnJlbnRQYXJhbWV0ZXJzKSA9PSBAZ2VuZXJhdGVSb3V0ZShwYXJhbWV0ZXJzKVxuICAgICAgICBpZiBAcGFyZW50XG4gICAgICAgICAgQHBhcmVudC5hY3RpdmF0ZSBwYXJhbWV0ZXJzLCBALCBhY3RpdmF0aW9uUHJvbWlzZVxuICAgICAgICAgIC50aGVuIChwYXJlbnRSZXNvbHZlUmVzdWx0KT0+XG4gICAgICAgICAgICBAZG9SZXNvbHZlIHBhcmFtZXRlcnMsIHBhcmVudFJlc29sdmVSZXN1bHRcbiAgICAgICAgICAgIC50aGVuIChyZXNvbHZlUmVzdWx0KT0+XG4gICAgICAgICAgICAgIEBwcmV2aW91c1Jlc29sdmVSZXN1bHQgPSByZXNvbHZlUmVzdWx0XG4gICAgICAgICAgICAgIHJlc29sdmVQcm9taXNlLnJlc29sdmUgcmVzb2x2ZVJlc3VsdFxuICAgICAgICBlbHNlXG4gICAgICAgICAgQGRvUmVzb2x2ZSBwYXJhbWV0ZXJzXG4gICAgICAgICAgLnRoZW4gKHJlc29sdmVSZXN1bHQpPT5cbiAgICAgICAgICAgIEBwcmV2aW91c1Jlc29sdmVSZXN1bHQgPSByZXNvbHZlUmVzdWx0XG4gICAgICAgICAgICByZXNvbHZlUHJvbWlzZS5yZXNvbHZlIHJlc29sdmVSZXN1bHRcbiAgICAgICAgQGN1cnJlbnRDaGlsZCA9IGNoaWxkXG4gICAgICAgIEBpc0FjdGl2ZSA9IHRydWVcbiAgICAgIGVsc2VcbiAgICAgICAgcmVzb2x2ZVByb21pc2UucmVzb2x2ZSBAcHJldmlvdXNSZXNvbHZlUmVzdWx0XG4gICAgICBhY3RpdmF0aW9uUHJvbWlzZS50aGVuIChyZXNvbHZlUmVzdWx0KT0+XG4gICAgICAgIEBvbkFjdGl2YXRlPyBwYXJhbWV0ZXJzLCByZXNvbHZlUmVzdWx0XG4gICAgICBAY3VycmVudFBhcmFtZXRlcnMgPSBwYXJhbWV0ZXJzXG4gICAgICByZXR1cm4gcmVzb2x2ZVByb21pc2VcblxuICAgIGRlYWN0aXZhdGU6ICgpLT5cbiAgICAgIEBpc0FjdGl2ZSA9IGZhbHNlXG4gICAgICBAb25EZWFjdGl2YXRlPygpXG4gICAgICBAY3VycmVudENoaWxkPy5kZWFjdGl2YXRlKClcbiAgICAgIEBjdXJyZW50Q2hpbGQgPSBudWxsXG5cbiAgICBnZW5lcmF0ZVJvdXRlOiAocGFyYW1ldGVycyktPlxuICAgICAgKGlmIEBwYXJlbnQ/LmdlbmVyYXRlUm91dGUocGFyYW1ldGVycykubGVuZ3RoIHRoZW4gQHBhcmVudC5nZW5lcmF0ZVJvdXRlKHBhcmFtZXRlcnMpKycvJyBlbHNlICcnKSArIGlmIEByb3V0ZSB0aGVuIF8udGVtcGxhdGUoQHJvdXRlKShwYXJhbWV0ZXJzKSBlbHNlICcnXG5cbiAgICBnZW5lcmF0ZVJvdXRlU3RyaW5nOiAoKS0+XG4gICAgICAoaWYgQHBhcmVudD8uZ2VuZXJhdGVSb3V0ZVN0cmluZygpLmxlbmd0aCB0aGVuIEBwYXJlbnQuZ2VuZXJhdGVSb3V0ZVN0cmluZygpICsgKGlmIEByb3V0ZSB0aGVuICcvJyBlbHNlICcnKSBlbHNlICcnKSArIGlmIEByb3V0ZSB0aGVuIEByb3V0ZSBlbHNlICcnXG5cbiAgICBnZW5lcmF0ZU5hbWU6ICgpLT5cbiAgICAgIChpZiBAcGFyZW50Py5zdGF0ZW5hbWUgdGhlbiBAcGFyZW50LmdlbmVyYXRlTmFtZSgpICsgJy4nIGVsc2UgJycpICsgQHN0YXRlbmFtZVxuXG4gICAgZ2V0UGFyZW50Q2hhaW46IC0+XG4gICAgICBjaGFpbiA9IEBwYXJlbnQ/LmdldFBhcmVudENoYWluKCkgb3IgW11cbiAgICAgIGNoYWluLnB1c2ggQFxuICAgICAgcmV0dXJuIGNoYWluXG4pXG4iXX0=